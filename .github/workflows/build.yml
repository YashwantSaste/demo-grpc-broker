name: Java SDK Build

on:
  push:
    paths:
      - 'src/main/proto/**'
      - 'pom.xml'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ› ï¸ Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: ğŸ§¹ Delete previously generated sources
        run: |
          echo "Deleting old src/generated folder..."
          rm -rf src/generated || echo "No existing generated folder found."

      - name: âš™ï¸ Run Maven to generate sources
        run: |
          echo "Running 'mvn clean compile' to regenerate proto classes..."
          mvn clean compile

      - name: ğŸ” Replace generated sources in src/
        run: |
          echo "Copying generated sources..."
          mkdir -p src/generated
          cp -r target/generated-sources/* src/generated/
          echo "Copied to src/generated."

      - name: âœ… Commit and push changes
        env:
          REPO_PAT: ${{ secrets.REPO_PAT }}
        run: |
          git config user.name "YashwantSaste"
          git config user.email "2021bec122@sggs.ac.in"

          if [ -n "$(git status --porcelain src/generated)" ]; then
            echo "Changes detected in src/generated, committing..."
            git add src/generated
            git commit -m "Update generated sources from proto files"
            git push https://x-access-token:$REPO_PAT@github.com/${{ github.repository }}.git
          else
            echo "No changes to commit."
